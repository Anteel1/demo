
service: api-to-sqs-to-lambda
frameworkVersion: '3'

provider:
  name: aws
  region: ap-southeast-1
  runtime: nodejs20.x
  stage: dev

  # Optional: still keep httpApi config (CORS), even though we define resources explicitly
  httpApi:
    payload: '2.0'
    cors: true

functions:
  # Lambda that consumes messages from the SQS queue
  worker:
    handler: handler.handler
    timeout: 30
    memorySize: 128
    events:
      - sqs:
          arn: !GetAtt RandomQueue.Arn
          batchSize: 5
          maximumBatchingWindow: 0

resources:
  Resources:
    # --- HTTP API & Stage ---
    HttpApi:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Name: !Sub "${self:service}-${self:provider.stage}"
        ProtocolType: HTTP
        CorsConfiguration:
          AllowOrigins:
            - "*"
          AllowMethods:
            - GET
            - OPTIONS
          AllowHeaders:
            - "*"

    HttpApiStage:
      Type: AWS::ApiGatewayV2::Stage
      Properties:
        ApiId: !Ref HttpApi
        StageName: !Sub "${self:provider.stage}"
        AutoDeploy: true

    # --- DLQ with unique name ---
    RandomDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: !Sub "random-dlq-${self:service}-${self:provider.stage}"
        MessageRetentionPeriod: 86400  # 1 day

    # --- Main Queue with unique name ---
    RandomQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: !Sub "random-queue-${self:service}-${self:provider.stage}"
        VisibilityTimeout: 180
        MessageRetentionPeriod: 3600    # 1 hour
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt RandomDLQ.Arn
          maxReceiveCount: 3

    # --- Role for API Gateway to send messages to SQS ---
    ApiGwToSqsRole:
      Type: AWS::IAM::Role
      Properties:
        # You can also omit RoleName entirely so CFN autogenerates a unique physical name
        RoleName: !Sub "api-to-sqs-role-${self:service}-${self:provider.stage}"
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: apigateway.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: AllowSendMessageToQueue
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action: sqs:SendMessage
                  Resource: !GetAtt RandomQueue.Arn

    # --- Integration: HTTP API → SQS (Service integration) ---
    HttpApiIntegrationToSqs:
      Type: AWS::ApiGatewayV2::Integration
      Properties:
        ApiId: !Ref HttpApi
        IntegrationType: AWS_PROXY
        IntegrationSubtype: SQS-SendMessage
        CredentialsArn: !GetAtt ApiGwToSqsRole.Arn
        PayloadFormatVersion: "1.0"
        RequestParameters:
          QueueUrl: !Ref RandomQueue
          # Send the querystring msg param as SQS message body
          # Example call: GET https://{apiId}.execute-api.{region}.amazonaws.com/dev/random?msg=hello
          MessageBody: "$request.querystring.msg"

    # --- Route: GET /random → the integration above ---
    HttpApiRouteRandom:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: !Ref HttpApi
        RouteKey: GET /random
        Target: !Join
          - /
          - - integrations
            - !Ref HttpApiIntegrationToSqs

  Outputs:
    ApiInvokeUrl:
      Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}"
      Description: "Invoke URL for HTTP API stage"
    QueueUrl:
      Value: !Ref RandomQueue
      Description: "URL of the main SQS queue"
    DLQUrl:
      Value: !Ref RandomDLQ
      Description: "URL of the dead-letter queue"
