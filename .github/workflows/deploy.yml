
name: Build & Deploy 3 services to EC2 (GHCR)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # ---- Registry & Naming ----
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/${{ github.event.repository.name }}
  # Ví dụ full path image sẽ là:
  # ghcr.io/<owner>/<repo>-api-gateway:<tag>
  # ghcr.io/<owner>/<repo>-note-module:<tag>
  # ghcr.io/<owner>/<repo>-resource-module:<tag>

  # ---- Tag ----
  IMAGE_TAG: ${{ github.sha }} # hoặc "latest"

permissions:
  contents: read
  packages: write     # cần để PUSH image lên GHCR bằng GITHUB_TOKEN

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      
      - name: Normalize owner/repo to lowercase
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_LOWER=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_PREFIX=${OWNER_LOWER}/${REPO_LOWER}" >> $GITHUB_ENV


      - name: Docker login to GHCR (for push)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      # ===== Build & push: api-gateway =====
      - name: Build api-gateway
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-api-gateway:${{ env.IMAGE_TAG }}"
          echo "Building $IMAGE"
          docker build \
            -f monorepo/apps/api-gateway/Dockerfile \
            -t "$IMAGE" \
            .
      - name: Push api-gateway
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-api-gateway:${{ env.IMAGE_TAG }}"
          docker push "$IMAGE"

      # ===== Build & push: note-module =====
      - name: Build note-module
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-note-module:${{ env.IMAGE_TAG }}"
          echo "Building $IMAGE"
          docker build \
            -f monorepo/apps/note-module/Dockerfile \
            -t "$IMAGE" \
            .
      - name: Push note-module
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-note-module:${{ env.IMAGE_TAG }}"
          docker push "$IMAGE"

      # ===== Build & push: resource-module =====
      - name: Build resource-module
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-resource-module:${{ env.IMAGE_TAG }}"
          echo "Building $IMAGE"
          docker build \
            -f monorepo/apps/resource-module/Dockerfile \
            -t "$IMAGE" \
            .
      - name: Push resource-module
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-resource-module:${{ env.IMAGE_TAG }}"
          docker push "$IMAGE"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (để lấy compose.yml nếu có)
        uses: actions/checkout@v4

      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      # (Tùy chọn) upload docker compose file lên EC2
      - name: Upload compose.yml to EC2
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            monorepo/compose.yml \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/monorepo/compose.yml
      - name: Deploy (SSH to EC2)
        env:
                EC2_SSH_KEY_PATH: ~/.ssh/deploy_key
                REGISTRY: ghcr.io
                IMAGE_PREFIX: ${{ github.repository_owner }}/${{ github.event.repository.name }}
                IMAGE_TAG: ${{ github.sha }}
                GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
                GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
                ./scripts/deploy.sh "${{ secrets.EC2_USER }}" "${{ secrets.EC2_HOST }}"


