{
  "id": "4",
  "title": "[AWS] Serverless deployment",
  "tag": "note",
  "content": "<font style=\"font-size: 24px;\"><b>*/ What make success for deployment ?</b> </font><div>\n1. Auditing changes\n2. Have a rollback or halt for bad deployment\n3. Deploying changes through the plan and automated process<div><br></div><div> ------------         ----          ---------------</div><div>| Developer |  =&gt; | IDE | =&gt; |  Source control  |</div><div><i> ------------         ----          ---------------</i></div><div><i><br></i></div><div>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div><i><br></i></div><div><font style=\"font-size: 24px;\"><b style=\"\">*/ Two truths about processing</b></font></div><div><font style=\"font-size: 24px;\"><b style=\"\"><br></b></font></div><div><i>* Still need to build and check locally</i></div><div><i>* Still need to deploy to sanbox ( Staging )</i></div><div><br></div><div>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div><br></div><div><b><font style=\"font-size: 24px;\">*/ AWS SAM </font></b></div><div><br></div><div>An Extention of AWS CloudFormation =&gt; Transform a shorthand syntax =&gt; Cloudformation syntax</div><div>=&gt; Create template for define Lambda function, API gateway, server less application ...</div><div><br></div><div>*SAM CLI =&gt; Testing locally</div><div><br></div><div>*Deploying SAM template</div><div>1. SAM template =&gt; define template</div><div>2. SAM package =&gt; create package =&gt; upload to S3</div><div>3. SAM deploy =&gt; deploy template to Cloudformation stack</div><div>4. SAM CLI =&gt; testing lambda code locally</div><div><br></div><div>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div><br></div><div><font style=\"font-size: 24px;\"><b>*/ ENV</b></font></div><div><br></div><div>1. Deployment package =&gt; Store in deployment package</div><div>2. Environment variable =&gt; Key value pair pass in Lambda function =&gt; Can not share between different function</div><div>3. Load run time =&gt; AWS Systems Manager Parameter </div></div><div>=&gt; Define a template</div><div>=&gt; Define extension for that template to use</div><div>=&gt; Grant permission</div><div><br></div><div>EX :</div><div><font style=\"font-size: 12px;\"><i>// nodejs file</i></font></div><div><font style=\"font-size: 12px;\"><i>const http = require('http');\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>const getFromExtension = (path) =&gt; {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>    return new Promise((resolve, reject) =&gt; {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const options = {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            hostname: 'localhost',\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            port: 2773,\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            path: path,\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            method: 'GET',\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            headers: {\n</i></font><i style=\"font-size: 12px; background-color: transparent;\">\n</i></div><div><font style=\"font-size: 12px;\"><i>                'X-Aws-Parameters-Secrets-Token': process.env.AWS_SESSION_TOKEN\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            }\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        };\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const req = http.request(options, (res) =&gt; {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            let data = '';\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            res.on('data', (chunk) =&gt; data += chunk);\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            res.on('end', () =&gt; {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                if (res.statusCode === 200) {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                    resolve(JSON.parse(data));\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                } else {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                    reject(new Error(`Lỗi Extension: ${res.statusCode} - ${data}`));\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                }\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            });\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        });\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        req.on('error', (err) =&gt; reject(err));\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        req.end();\n</i></font></div><div><font style=\"font-size: 12px;\"><i>    });\n</i></font></div><div><font style=\"font-size: 12px;\"><i>};\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>exports.handler = async (event) =&gt; {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>    try {\n</i></font><i style=\"font-size: 12px; background-color: transparent;\">\n</i></div><div><font style=\"font-size: 12px;\"><i>        const paramName = encodeURIComponent('/my-app/api-url');\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const ssmData = await getFromExtension(`/systemsmanager/parameters/get?name=${paramName}`);\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const apiUrl = ssmData.Parameter.Value;\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const secretName = encodeURIComponent('my-db-secret');\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const secretData = await getFromExtension(`/secretsmanager/get?secretId=${secretName}`);\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        const dbCredentials = JSON.parse(secretData.SecretString);\n</i></font></div><div><font style=\"font-size: 12px;\"><i>\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        return {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            statusCode: 200,\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            body: JSON.stringify({\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                message: \"Lấy tài nguyên thành công từ Extension\",\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                url: apiUrl,\n</i></font></div><div><font style=\"font-size: 12px;\"><i>                dbUser: dbCredentials.username\n</i></font></div><div><font style=\"font-size: 12px;\"><i>            })\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        };\n</i></font></div><div><font style=\"font-size: 12px;\"><i>    } catch (error) {\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        console.error(error);\n</i></font></div><div><font style=\"font-size: 12px;\"><i>        return { statusCode: 500, body: \"Internal Error\" };\n</i></font></div><div><font style=\"font-size: 12px;\"><i>    }\n</i></font></div><div><font style=\"font-size: 12px;\"><i>};</i></font></div><div> </div><div><font style=\"font-size: 12px;\"><i>// template file</i></font></div><div><font style=\"font-size: 12px;\"><i>AWSTemplateFormatVersion: '2010-09-09'</i></font></div><div><font style=\"font-size: 12px;\"><i>Transform: AWS::Serverless-2016-10-31</i></font></div><div><font style=\"font-size: 12px;\"><i>Resources:</i></font></div><div><font style=\"font-size: 12px;\"><i>  MySharedResourceFunction:</i></font></div><div><font style=\"font-size: 12px;\"><i>    Type: AWS::Serverless::Function</i></font></div><div><font style=\"font-size: 12px;\"><i>    Properties:</i></font></div><div><font style=\"font-size: 12px;\"><i>      Handler: index.handler</i></font></div><div><font style=\"font-size: 12px;\"><i>      Runtime: nodejs20.x</i></font></div><div><font style=\"font-size: 12px;\"><i>      Architectures:</i></font></div><div><font style=\"font-size: 12px;\"><i>        - x86_64</i></font></div><div><font style=\"font-size: 12px;\"><i>      # 1. Thêm Extension Layer (ARN này thay đổi theo Region)</i></font></div><div><font style=\"font-size: 12px;\"><i>      # Ví dụ này cho vùng us-east-1 (N. Virginia)</i></font></div><div><font style=\"font-size: 12px;\"><i>      Layers:</i></font></div><div><font style=\"font-size: 12px;\"><i>        - arn:aws:lambda:us-east-1:177933130628:layer:AWS-Parameters-and-Secrets-Lambda-Extension:12</i></font></div><div><font style=\"font-size: 12px;\"><i>      Policies:</i></font></div><div><font style=\"font-size: 12px;\"><i>        - SSMParameterReadPolicy:</i></font></div><div><font style=\"font-size: 12px;\"><i>            ParameterName: \"my-app/api-url\"</i></font></div><div><font style=\"font-size: 12px;\"><i>      Environment:</i></font></div><div><font style=\"font-size: 12px;\"><i>        Variables:</i></font></div><div><font style=\"font-size: 12px;\"><i>          SSM_PARAMETER_NAME: \"/my-app/api-url\"</i></font></div><div><font style=\"font-size: 12px;\"><i>          # Tùy chỉnh thời gian cache (giây) - mặc định là 300s</i></font></div><div><font style=\"font-size: 12px;\"><i>          PARAMETERS_SECRETS_EXTENSION_CACHE_SIZE: \"1000\"</i></font></div><div><font style=\"font-size: 12px;\"><i>          PARAMETERS_SECRETS_EXTENSION_HTTP_PORT: \"2773\"</i></font></div><div><font style=\"font-size: 12px;\"><i>          PARAMETERS_SECRETS_EXTENSION_LOG_LEVEL: \"info\"</i></font></div><div><font style=\"font-size: 12px;\"><i><br></i></font></div><div><font style=\"font-size: 12px;\"><i>  MyApiUrlParameter:</i></font></div><div><font style=\"font-size: 12px;\"><i>    Type: AWS::SSM::Parameter</i></font></div><div><font style=\"font-size: 12px;\"><i>    Properties:</i></font></div><div><font style=\"font-size: 12px;\"><i>      Name: \"/my-app/api-url\"</i></font></div><div><font style=\"font-size: 12px;\"><i>      Type: String</i></font></div><div><font style=\"font-size: 12px;\"><i>      Value: \"https://api.example.com/v1\"</i></font></div><div><br></div><div>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div><br></div><div><font style=\"font-size: 24px;\"><b>*/ Deployment </b></font></div><div><br></div><div>All at once : </div><div>Delivery all the new code to deployment at once</div><div><br></div><div>Canary :</div><div>Spliting small production traffic =&gt; after validating ok =&gt; move 100% </div><div><br></div><div>Linear : </div><div>Shifting production traffic for time =&gt; Ex : Linear10percentperminute =&gt; it will delivery 10% traffic each 10 minute</div><div><br></div><div><u><font style=\"font-size: 18px;\">*Trigger</font></u></div><div><i><br></i></div><div><i>Pre-traffic hooks - Started before the alias can accept traffic</i></div><div><i><br></i></div><div><i>\n</i></div><div><i>Post-traffic hooks - Started after traffic shift</i></div><div><i><br></i></div><div><i>\n</i></div><div><i>Alarms - Helpful to trigger the rollback process</i></div><div><i><br></i></div><div><i>\n</i></div><div><i>Deployment preferences - Where you choose whether you want a canary, linear, or all-at-once <span style=\"background-color: transparent;\">deployment</span></i></div><div><i><br></i></div><div><i>\n</i></div><div><i>Hooks - Sanity checks to test and perform actions against your code</i></div><div><br></div><div>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div><br><b><font style=\"font-size: 18px;\">*/ CICD</font></b></div><div><br></div><div><img src=\"http://127.0.0.1:3000/1766996440990-bb293753-2ea8-4d66-9ecb-5bc2851412ef.png\" alt=\"Pasted image\"><br></div><div><br></div><div><b>*/ LAMBDA EXECUTION</b></div><div><br></div><div><img src=\"http://127.0.0.1:3000/1767169859266-0097170e-588e-4781-9c99-409174c56ca2.png\" alt=\"Pasted image\"><br>Execution phase :</div><div>Init phase</div><div>Invoke phase</div><div>Shutdown phase</div><div><br></div><div><font style=\"font-size: 24px;\"><b><img src=\"http://127.0.0.1:3000/1767170802447-2fb6a1aa-6875-4786-a5e5-20da25e17a92.png\" alt=\"Pasted image\"></b></font></div><div>Cold start :</div><div>- When new instance have init to execute lambda function</div><div>Warm start :</div><div>- After that instance init success fully and can stay to next receive request</div>",
  "updatedAt": "2025-12-31T09:11:18.607Z"
}